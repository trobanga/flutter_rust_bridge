<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Async in Rust - flutter_rust_bridge</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Part I: Core</li><li class="chapter-item expanded "><a href="../quickstart.html"><strong aria-hidden="true">1.</strong> ðŸ§­ Quickstart</a></li><li class="chapter-item expanded "><a href="../tutorial_with_flutter.html"><strong aria-hidden="true">2.</strong> ðŸ“š Tutorial: A Flutter+Rust app</a></li><li class="chapter-item expanded "><a href="../feature.html"><strong aria-hidden="true">3.</strong> ðŸŽ¼ Features</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../feature/lang.html"><strong aria-hidden="true">3.1.</strong> Language translations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../feature/lang_vec.html"><strong aria-hidden="true">3.1.1.</strong> Vec</a></li><li class="chapter-item expanded "><a href="../feature/lang_struct.html"><strong aria-hidden="true">3.1.2.</strong> Struct</a></li><li class="chapter-item expanded "><a href="../feature/lang_enum.html"><strong aria-hidden="true">3.1.3.</strong> Enum</a></li><li class="chapter-item expanded "><a href="../feature/lang_external.html"><strong aria-hidden="true">3.1.4.</strong> External types</a></li><li class="chapter-item expanded "><a href="../feature/lang_option.html"><strong aria-hidden="true">3.1.5.</strong> Option</a></li></ol></li><li class="chapter-item expanded "><a href="../feature/zero_copy.html"><strong aria-hidden="true">3.2.</strong> Zero copy</a></li><li class="chapter-item expanded "><a href="../feature/stream.html"><strong aria-hidden="true">3.3.</strong> Stream / Iterator</a></li><li class="chapter-item expanded "><a href="../feature/async_dart.html"><strong aria-hidden="true">3.4.</strong> Async in Dart</a></li><li class="chapter-item expanded "><a href="../feature/sync_dart.html"><strong aria-hidden="true">3.5.</strong> Sync in Dart</a></li><li class="chapter-item expanded "><a href="../feature/concurrency.html"><strong aria-hidden="true">3.6.</strong> Concurrency</a></li><li class="chapter-item expanded "><a href="../feature/handler.html"><strong aria-hidden="true">3.7.</strong> Handler</a></li><li class="chapter-item expanded "><a href="../feature/init.html"><strong aria-hidden="true">3.8.</strong> Initialization</a></li><li class="chapter-item expanded "><a href="../feature/async_rust.html"><strong aria-hidden="true">3.9.</strong> Async in Rust</a></li><li class="chapter-item expanded "><a href="../feature/cancelable_task.html"><strong aria-hidden="true">3.10.</strong> Cancellable tasks</a></li><li class="chapter-item expanded "><a href="../feature/object_pool.html"><strong aria-hidden="true">3.11.</strong> Object pools</a></li><li class="chapter-item expanded "><a href="../feature/misc.html"><strong aria-hidden="true">3.12.</strong> Miscellaneous</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Part II: User Guide</li><li class="chapter-item expanded "><a href="../template.html"><strong aria-hidden="true">4.</strong> Create new projects from a template</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../template/setup.html"><strong aria-hidden="true">4.1.</strong> Creating a new project</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../template/setup_android.html"><strong aria-hidden="true">4.1.1.</strong> Android setup</a></li><li class="chapter-item expanded "><a href="../template/setup_ios.html"><strong aria-hidden="true">4.1.2.</strong> iOS setup</a></li><li class="chapter-item expanded "><a href="../template/setup_web.html"><strong aria-hidden="true">4.1.3.</strong> Web setup</a></li><li class="chapter-item expanded "><a href="../template/setup_desktop.html"><strong aria-hidden="true">4.1.4.</strong> Windows and Linux</a></li><li class="chapter-item expanded "><a href="../template/setup_others.html"><strong aria-hidden="true">4.1.5.</strong> Other platforms</a></li></ol></li><li class="chapter-item expanded "><a href="../template/tour.html"><strong aria-hidden="true">4.2.</strong> Template tour</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../template/tour_api.html"><strong aria-hidden="true">4.2.1.</strong> native/src/api.rs</a></li><li class="chapter-item expanded "><a href="../template/tour_gradle.html"><strong aria-hidden="true">4.2.2.</strong> android/app/build.gradle</a></li><li class="chapter-item expanded "><a href="../template/tour_native_proj.html"><strong aria-hidden="true">4.2.3.</strong> native/native.xcodeproj</a></li><li class="chapter-item expanded "><a href="../template/tour_justfile.html"><strong aria-hidden="true">4.2.4.</strong> justfile</a></li><li class="chapter-item expanded "><a href="../template/tour_cmake.html"><strong aria-hidden="true">4.2.5.</strong> rust.cmake</a></li></ol></li><li class="chapter-item expanded "><a href="../template/generate.html"><strong aria-hidden="true">4.3.</strong> Generating code</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../template/generate_install.html"><strong aria-hidden="true">4.3.1.</strong> Installing codegen</a></li><li class="chapter-item expanded "><a href="../template/generate_adding_code.html"><strong aria-hidden="true">4.3.2.</strong> Adding new code</a></li><li class="chapter-item expanded "><a href="../template/generate_build_runner.html"><strong aria-hidden="true">4.3.3.</strong> Using build_runner</a></li><li class="chapter-item expanded "><a href="../template/generate_finish.html"><strong aria-hidden="true">4.3.4.</strong> Wrapping up</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../integrate.html"><strong aria-hidden="true">5.</strong> Integrating with existing projects</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../integrate/new_crate.html"><strong aria-hidden="true">5.1.</strong> Creating a new crate</a></li><li class="chapter-item expanded "><a href="../integrate/deps.html"><strong aria-hidden="true">5.2.</strong> Installing dependencies</a></li><li class="chapter-item expanded "><a href="../integrate/android.html"><strong aria-hidden="true">5.3.</strong> Integrating with Android</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../integrate/android_tasks.html"><strong aria-hidden="true">5.3.1.</strong> Hooking onto tasks</a></li><li class="chapter-item expanded "><a href="../integrate/android_cmake.html"><strong aria-hidden="true">5.3.2.</strong> CMake with Gradle</a></li></ol></li><li class="chapter-item expanded "><a href="../integrate/ios.html"><strong aria-hidden="true">5.4.</strong> Integrating with iOS/MacOS</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../integrate/ios_proj.html"><strong aria-hidden="true">5.4.1.</strong> Creating the Rust project</a></li><li class="chapter-item expanded "><a href="../integrate/ios_linking.html"><strong aria-hidden="true">5.4.2.</strong> Linking the project</a></li><li class="chapter-item expanded "><a href="../integrate/ios_gen.html"><strong aria-hidden="true">5.4.3.</strong> Generating bindings</a></li><li class="chapter-item expanded "><a href="../integrate/ios_headers.html"><strong aria-hidden="true">5.4.4.</strong> Using dummy headers</a></li></ol></li><li class="chapter-item expanded "><a href="../integrate/desktop.html"><strong aria-hidden="true">5.5.</strong> Integrating with Windows and Linux</a></li><li class="chapter-item expanded "><a href="../integrate/web.html"><strong aria-hidden="true">5.6.</strong> Integrating with Web</a></li><li class="chapter-item expanded "><a href="../integrate/usage.html"><strong aria-hidden="true">5.7.</strong> Using the dynamic library</a></li><li class="chapter-item expanded "><a href="../integrate/finish.html"><strong aria-hidden="true">5.8.</strong> Wrapping up</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Part III: More Doc</li><li class="chapter-item expanded "><a href="../tutorial_pure_dart.html"><strong aria-hidden="true">6.</strong> Tutorial: Pure Dart</a></li><li class="chapter-item expanded "><a href="../safety.html"><strong aria-hidden="true">7.</strong> Safety concerns</a></li><li class="chapter-item expanded "><a href="../troubleshooting.html"><strong aria-hidden="true">8.</strong> Troubleshooting</a></li><li class="chapter-item expanded "><a href="../command_line.html"><strong aria-hidden="true">9.</strong> Command line arguments</a></li><li class="chapter-item expanded "><a href="../set_up_from_scratch.html"><strong aria-hidden="true">10.</strong> Set up Flutter/Dart+Rust support from scratch</a></li><li class="chapter-item expanded "><a href="../article.html"><strong aria-hidden="true">11.</strong> Articles</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../article/async_in_rust.html" class="active"><strong aria-hidden="true">11.1.</strong> Async in Rust</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">flutter_rust_bridge</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="async-in-rust"><a class="header" href="#async-in-rust">Async in Rust</a></h1>
<p>Author: @AlienKevin</p>
<p>This library does not yet support returning a Future type from Rust and this has to do with the difficulty of uniting the various approaches to async in Rust. The <a href="https://rust-lang.github.io/async-book/01_getting_started/03_state_of_async_rust.html#language-and-library-support">Rust Book</a> summarized the current state of async support succinctly:</p>
<blockquote>
<p>The most fundamental traits, types and functions, such as the Future trait are provided by the standard library. The async/await syntax is supported directly by the Rust compiler.</p>
</blockquote>
<blockquote>
<p>Many utility types, macros and functions are provided by the futures crate. They can be used in any async Rust application.</p>
</blockquote>
<blockquote>
<p>Execution of async code, IO and task spawning are provided by &quot;async runtimes&quot;, such as Tokio and async-std. Most async applications, and some async crates, depend on a specific runtime.</p>
</blockquote>
<p>While the futures crate provides an executor called <code>futures::executor::block_on</code>, libraries that use Tokio runtime cannot use this executor. According to <a href="https://runrust.miraheze.org/wiki/Async_crate_comparison">Rust-lang community wiki</a>, crates like Tokio that provide both a runtime and IO abstractions often have their IO depend on the runtime. This can make it difficult to write runtime-agnostic code. First, we demonstrate a common use case of async programming in Rust by attempting to fetch the content of a file from the internet using the popular HTTP Client <a href="https://docs.rs/reqwest/0.11.6/reqwest/">Reqwest</a>:</p>
<pre><code class="language-rust ignore">use anyhow;

async fn get() -&gt; anyhow::Result&lt;String&gt; {
    let url = &quot;https://link/to/file/download&quot;;
    let data = reqwest::get(url).await?.text().await?;
    Ok(data)
}
</code></pre>
<p>When you try to generate bindings for the <code>get</code> function, the generated code will contain errors because this library does not support returning Future from Rust.</p>
<h2 id="mismatched-runtime"><a class="header" href="#mismatched-runtime">Mismatched runtime</a></h2>
<p>The next logic thing to try would be to convert the asynchronous code to synchronous by directly blocking the current thread and execute the code. For our first attempt, we wrap <code>futures::executor::block_on</code> around an async block containing reqwest calls.</p>
<pre><code class="language-rust ignore">use anyhow;
use futures::executor::block_on;

fn get() -&gt; anyhow::Result&lt;String&gt; {
    block_on(async {
        let url = &quot;https://link/to/file/download&quot;;
        let data = reqwest::get(url).await?.text().await?;
        Ok(data)
    })
}
</code></pre>
<p>Since Reqwest uses the Tokio runtime instead of the futures runtime, our code panicked with the error &quot;there is no reactor running, must be called from the context of a Tokio 1.x runtime&quot;. To fix this error, we have two ways to execute async codes using the Tokio runtime. Approach 1 is the simplest and uses the convenient <a href="https://docs.rs/tokio/1.14.0/tokio/attr.main.html"><code>tokio::main</code></a> macro to turn an async function to a synchronous one. Approach 2 requires you to explicitly create a new Tokio runtime and use its block_on function to run the future to completion.</p>
<h2 id="approach-1-macro"><a class="header" href="#approach-1-macro">Approach 1 (macro)</a></h2>
<pre><code class="language-rust ignore">use anyhow;

#[tokio::main(flavor = &quot;current_thread&quot;)]
async fn get() -&gt; anyhow::Result&lt;String&gt; {
    let url = &quot;https://link/to/file/download&quot;;
    let data = reqwest::get(url).await?.text().await?;
    Ok(data)
}
</code></pre>
<p>It has the following dependencies:</p>
<pre><code class="language-toml">[dependencies]
futures = &quot;0.3&quot;
reqwest = &quot;0.11.6&quot;
tokio = { version = &quot;1.14.0&quot;, features = [&quot;rt&quot;, &quot;macros&quot;] }
anyhow = { version = &quot;1.0.49&quot; }
</code></pre>
<h2 id="approach-2-runtime"><a class="header" href="#approach-2-runtime">Approach 2 (runtime)</a></h2>
<pre><code class="language-rust ignore">use anyhow;
use tokio::runtime::Runtime;

fn get() -&gt; anyhow::Result&lt;String&gt; {
    let rt = Runtime::new().unwrap();
    rt.block_on(async {
        let url = &quot;https://link/to/file/download&quot;;
        let data = reqwest::get(url).await?.text().await?;
        Ok(data)
    })
}
</code></pre>
<p>It has the following dependencies:</p>
<pre><code class="language-toml">[dependencies]
futures = &quot;0.3&quot;
reqwest = &quot;0.11.6&quot;
tokio = { version = &quot;1.14.0&quot;, features = [&quot;rt-multi-thread&quot;] }
anyhow = { version = &quot;1.0.49&quot; }
</code></pre>
<h2 id="plain-futures"><a class="header" href="#plain-futures">Plain futures</a></h2>
<p>If you are using the plain futures crate without runtimes like Tokio, you should be safe to wrap the asynchronous code in an async block and use the <a href="https://docs.rs/futures/0.3.18/futures/executor/fn.block_on.html"><code>futures::executor::block_on</code></a> to run the future to completion:</p>
<pre><code class="language-rust ignore">use futures::executor::block_on;

async fn hello_world() -&gt; String {
    &quot;hello, world!&quot;.to_string()
}

fn get() -&gt; String {
    block_on(async {
        hello_world().await
    })
}

fn main() {
    println!(&quot;{}&quot;, get()); // prints &quot;hello, world!&quot;
}
</code></pre>
<h2 id="avoid-async"><a class="header" href="#avoid-async">Avoid async</a></h2>
<p>Lastly, you can avoid async code all together by using synchronously/blocking version of the functions if they are available. In Reqwest, there's a module called <code>reqwest::blocking</code> designed specifically for this purpose. So you can achieve the same thing above without using async.</p>
<pre><code class="language-rust ignore">use anyhow;
use reqwest;

fn get() -&gt; anyhow::Result&lt;String&gt; {
    let url = &quot;https://link/to/file/download&quot;;
    let data = reqwest::blocking::get(url)?.text()?;
    Ok(data)
}
</code></pre>
<p>It has the following dependencies:</p>
<pre><code class="language-toml">[dependencies]
futures = &quot;0.3&quot;
reqwest = { version = &quot;0.11.6&quot;, features = [&quot;blocking&quot;] }
anyhow = { version = &quot;1.0.49&quot; }
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../article.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../article.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
